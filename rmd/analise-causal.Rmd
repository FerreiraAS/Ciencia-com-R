# **Análise causal** {#analise-causal}

<br>

## Causalidade

<br>

### O que é análise causal?

-   Análise causal é usada para explicar a relação entre causa e efeito em um conjunto de dados, respondendo a perguntas do tipo "por quê?".[@gerring2012]

-   Análise causal implica em contrafactual, no sentido de que a análise causal é baseada na comparação entre o que realmente aconteceu e o que teria acontecido se uma ou mais variáveis tivessem sido diferentes.[@gerring2012]

<br>

## Questões orientadoras para avaliar causalidade em estudos observacionais

<br>

### Como diferenciar associação de causalidade?

-   Associação descreve que duas variáveis variam juntas, mas não garante que uma afete a outra.[@vickers2023]

-   Causalidade exige evidências (diretas ou indiretas) de que modificar a variável de exposição altera o desfecho.[@vickers2023]

<br>

### Quais critérios ajudam a sustentar inferência causal?

-   Existência de um mecanismo plausível.[@vickers2023]

-   Controle adequado de confundidores (medidos e não medidos).[@vickers2023]

-   Consistência com literatura prévia e plausibilidade do tamanho do efeito.[@vickers2023]

-   Avaliação de alternativas explicativas (ex.: viés de seleção, mediadores não controlados).[@vickers2023]

<br>

### Qual o papel dos caminhos causais (DAGs)?

-   Ajudam a identificar quais variáveis precisam ser medidas e ajustadas.[@vickers2023]

-   Evitam ajustes indevidos (ex.: em colisores), que podem introduzir viés.[@vickers2023]

<br>

### Como lidar com confundimento residual?

-   Reconhecer que modelos multivariados e escores de propensão não eliminam completamente o confundimento.[@vickers2023]

-   Comparar características basais entre grupos para identificar diferenças persistentes.[@vickers2023]

-   Considerar análises de sensibilidade, mas com cautela na interpretação.[@vickers2023]

<br>

## Linguagem causal em estudos observacionais

<br>

### Quais são as principais recomendações para relatar causalidade?

- Usar termos causais de forma explícita e criteriosa (“causa”, “efeito”, “reduzir”, “aumentar”), evitando expressões ambíguas como “fator de risco”.[@vickers2023]

- Contextualizar a causalidade em termos práticos, explicando por que identificar a causa é relevante para intervenções.[@vickers2023]

- Declarar claramente na introdução se existe hipótese causal, justificando quando não houver.[@vickers2023]

- Descrever caminhos causais (mediadores, confundidores, colisores) em texto claro ou com diagramas.[@vickers2023]

- Justificar a seleção de covariáveis com base nas relações causais previstas.[@vickers2023]

- Avaliar o controle de confundimento, reconhecendo limitações e possível confundimento residual.[@vickers2023]

- Discutir as inferências causais considerando estimativas, vieses e plausibilidade biológica.[@vickers2023]

- Indicar recomendações específicas para pesquisas futuras ou prática clínica baseadas nas conclusões causais.[@vickers2023]

<br>

## Diagramas acíclicos direcionados (DAGs)

<br>

### O que são DAGs?

-   DAGs são representações gráficas de relações causais entre variáveis, usando nós (variáveis) e arestas direcionadas (relações causais).[@REF]

-   DAGs ajudam a identificar confundidores, mediadores e colisores, orientando a seleção de variáveis para ajuste em análises estatísticas.[@REF]

-   DAGs são acíclicos, ou seja, não permitem ciclos ou loops, refletindo a natureza unidirecional das relações causais.[@REF]

<br>

### Quais são os padrões causais básicos?

-   Independência: duas variáveis não têm relação causal direta ou indireta.[@REF]

-   Cadeia: uma variável causa outra, que por sua vez causa uma terceira (X → M → Y).[@REF]

-   Garfo: uma variável causa duas outras (X ← Z → Y), onde Z é um confundidor.[@REF]

-   Colisor: duas variáveis causam uma terceira (X → Z ← Y), onde Z é um colisor.[@REF]

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *dagitty*[@dagitty] fornece a função [*dagitty*](https://cran.r-project.org/web/packages/dagitty/index.html) para criar um objeto grafo a partir de uma descrição textual.
:::

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *ggdag*[@ggdag] fornece a função [*ggdag*](https://www.rdocumentation.org/packages/ggdag/versions/0.2.10/topics/ggdag) para criar figuras de grafos.
:::

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *performance*[@performance] fornece a função [*check_dag*](https://easystats.github.io/performance/reference/check_dag.html) para criar, verificar e visualizar os modelos em grafos.
:::

<br>

```{r dag, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, appendix = TRUE, fig.align = 'center', results = "asis", fig.fullwidth = TRUE, fig.cap = "Padrões causais básicos: independência, cadeia, garfo e colisor.", out.width = "90%"}
# ---------- Funções auxiliares ----------
.build_nodes_df <- function(dag, panel_label){
  coords <- dagitty::coordinates(dag)
  nms <- union(names(coords$x), names(coords$y))
  x <- unname(coords$x[nms]); names(x) <- NULL
  y <- unname(coords$y[nms]); names(y) <- NULL
  data.frame(
    name  = nms, x = as.numeric(x), y = as.numeric(y),
    panel = panel_label, stringsAsFactors = FALSE
  )
}

.build_edges_df <- function(dag, nodes_df){
  ed <- dagitty::edges(dag)
  if(nrow(ed) == 0L) return(data.frame())
  x_of <- function(nm) nodes_df$x[match(nm, nodes_df$name)]
  y_of <- function(nm) nodes_df$y[match(nm, nodes_df$name)]
  data.frame(
    x     = x_of(ed$v), y    = y_of(ed$v),
    xend  = x_of(ed$w), yend = y_of(ed$w),
    panel = nodes_df$panel[1], stringsAsFactors = FALSE
  )
}

# Encurtar arestas para não invadir os nós
trim_edges_to_node_border <- function(edges, node_r = 0.085){
  if(nrow(edges) == 0L) return(edges)
  dx  <- edges$xend - edges$x
  dy  <- edges$yend - edges$y
  L   <- sqrt(dx*dx + dy*dy)
  ux  <- dx / L
  uy  <- dy / L
  # recua na origem e no destino
  edges$x    <- edges$x    + ux * node_r
  edges$y    <- edges$y    + uy * node_r
  edges$xend <- edges$xend - ux * node_r
  edges$yend <- edges$yend - uy * node_r
  edges
}

# ---------- DAGs ----------
dag_ind <- dagitty::dagitty("dag { X Y }")
dagitty::coordinates(dag_ind) <- list(x = c(X=0, Y=1), y = c(X=0, Y=0))

dag_chain <- dagitty::dagitty("dag { X -> M -> Y }")
dagitty::coordinates(dag_chain) <- list(x = c(X=0, M=0.5, Y=1), y = c(X=0, M=0, Y=0))

dag_fork <- dagitty::dagitty("dag { X <- Z -> Y }")
dagitty::coordinates(dag_fork) <- list(x = c(X=0, Z=0.5, Y=1), y = c(X=0, Z=0, Y=0))

dag_coll <- dagitty::dagitty("dag { X -> Z <- Y }")
dagitty::coordinates(dag_coll) <- list(x = c(X=0, Z=0.5, Y=1), y = c(X=0, Z=0, Y=0))

# ---------- Data frames ----------
nodes_all <- rbind(
  .build_nodes_df(dag_ind,   "1) Independência"),
  .build_nodes_df(dag_chain, "2) Cadeia (X → M → Y)"),
  .build_nodes_df(dag_fork,  "3) Garfo (X ← Z → Y)"),
  .build_nodes_df(dag_coll,  "4) Colisor (X → Z ← Y)")
)

edges_all <- rbind(
  .build_edges_df(dag_ind,   subset(nodes_all, panel == "1) Independência")),
  .build_edges_df(dag_chain, subset(nodes_all, panel == "2) Cadeia (X → M → Y)")),
  .build_edges_df(dag_fork,  subset(nodes_all, panel == "3) Garfo (X ← Z → Y)")),
  .build_edges_df(dag_coll,  subset(nodes_all, panel == "4) Colisor (X → Z ← Y)"))
)

# *** Ajuste importante: encurtar arestas ***
edges_all <- trim_edges_to_node_border(edges_all, node_r = 0.085)  # aumente/diminua se mudar o size do nó

# ---------- Plot ----------
p <- ggplot2::ggplot() +
  # Arestas com setas visíveis
  ggplot2::geom_segment(
    data = edges_all,
    mapping = ggplot2::aes(x = x, y = y, xend = xend, yend = yend),
    arrow = grid::arrow(length = grid::unit(0.28, "in"), ends = "last", type = "closed"),
    linewidth = 1
  ) +
  # Nós grandes (círculo branco com contorno)
  ggplot2::geom_point(
    data = nodes_all,
    mapping = ggplot2::aes(x = x, y = y),
    shape = 21, fill = "white", color = "black",
    stroke = 1.6, size = 14
  ) +
  # Letras dentro dos círculos
  ggplot2::geom_text(
    data = nodes_all,
    mapping = ggplot2::aes(x = x, y = y, label = name),
    size = 6, fontface = "bold", vjust = 0.35, hjust = 0.5
  ) +
  ggdag::theme_dag() +
  ggplot2::facet_wrap(~ panel, ncol = 2) +
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5, size = 14),
    panel.spacing = grid::unit(5, "lines"),
    plot.margin = grid::unit(c(0.5, 0.5, 0.5, 0.5), "cm")
  ) +
  ggplot2::coord_cartesian(clip = "off")

print(p)
```

<br>

```{r, echo=FALSE, warning=FALSE, results='asis', eval=knitr::is_html_output()}
cat(readLines("citation.html"), sep = "\n")
```

<br>
