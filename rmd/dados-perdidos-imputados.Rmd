# **Dados perdidos e imputados** {#dados-perdidos-imputados}

<br>

## Dados perdidos

<br>

### O que são dados perdidos?

-   Dados perdidos são dados não coletados de um ou mais participantes, para uma ou mais variáveis.[@Altman2007]

<br>

```{r dados-perdidos, echo = FALSE, warning = FALSE, message = FALSE, appendix = TRUE, fig.align = 'center', layout='Blank', ph=officer::ph_location_fullsize(), results = "asis", fig.fullwidth = TRUE}
# Reprodutibilidade
set.seed(123)

# Simulação de dados de um RCT (n = 10)
n <- 10
rct10 <- data.frame(
  id = 1:n,
  Grupo = sample(c("Controle", "Intervenção"), n, replace = TRUE),
  Idade = sample(40:75, n, replace = TRUE),
  Sexo = sample(c("M", "F"), n, replace = TRUE),
  "Desfecho (pré)" = rnorm(n, mean = 50, sd = 10),
  "Desfecho (pós)" = rnorm(n, mean = 55, sd = 12),
  check.names = FALSE
)

# Introduzir dados perdidos (MCAR)
rct10[["Desfecho (pós)"]][sample(1:n, 3)] <- NA  # 3 perdas no pós
rct10$Idade[sample(1:n, 2)] <- NA                # 2 perdas em Idade

# (Opcional) arredondar desfechos para visualização
rct10[["Desfecho (pré)"]] <- round(rct10[["Desfecho (pré)"]], 1)
rct10[["Desfecho (pós)"]] <- round(rct10[["Desfecho (pós)"]], 1)

# exibir a tabela de 10 indivíduos simulada
kableExtra::kable(
  rct10,
  align = "c",
  format = ifelse(knitr::is_html_output(), "html", "latex"),
  booktabs = TRUE,
  linesep = "",
  escape = FALSE,
  caption = "Simulação de uma amostra (n=10) de um ensaio clínico aleatorizado (dados com perdas aleatórias)."
) %>%
  kableExtra::kable_styling(
    latex_options = c("basic"),
    bootstrap_options = c("basic", "hover", "condensed", "responsive"),
    full_width = ifelse(knitr::is_html_output(), TRUE, TRUE),
    position = "center"
  ) %>%
  kableExtra::row_spec(0, bold = TRUE, extra_css = "border-top: 1px solid; border-bottom: 1px solid") %>%
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::row_spec(dim(rct10)[1], extra_css = "border-bottom: 1px solid")
```

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *base*[@base] fornece a função [*is.na*](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/na) para identificar que elementos de um objeto são dados perdidos.
:::

<br>

### Qual o problema de um estudo ter dados perdidos?

-   Uma grande quantidade de dados perdidos pode comprometer a integridade científica do estudo, considerando-se que o tamanho da amostra foi estimado para observar um determinado tamanho de efeito mínimo.[@Altman2007]

-   Perda de participantes no estudo por dados perdidos pode reduzir o poder estatístico (erro tipo II).[@Altman2007]

-   Não existe solução globalmente satisfatória para o problema de dados perdidos.[@Altman2007]

<br>

## Mecanismos geradores de dados perdidos

<br>

### Quais os mecanismos geradores de dados perdidos?

-   Dados perdidos completamente ao acaso (*missing completely at random*, MCAR), em que os dados perdidos estão distribuídos aleatoriamente nos dados da amostra.[@Heymans2022; @carpenter2021]

<br>

```{r mcar, echo = FALSE, warning = FALSE, message = FALSE, appendix = TRUE, fig.align = 'center', layout='Blank', ph=officer::ph_location_fullsize(), results = "asis", fig.fullwidth = TRUE, fig.cap = "Representação gráfica de dados perdidos completamente ao acaso (MCAR) em um estudo randomizado controlado (RCT)."}
# para reproduzir o exemplo
set.seed(123)

# Simulação de dados de um RCT
n <- 200
rct_data <- data.frame(
  id = 1:n,
  Grupo = sample(c("Controle", "Intervenção"), n, replace = TRUE),
  Idade = sample(40:75, n, replace = TRUE),
  Sexo = sample(c("M", "F"), n, replace = TRUE),
  "Desfecho (pré)" = rnorm(n, mean = 50, sd = 10),
  "Desfecho (pós)" = rnorm(n, mean = 55, sd = 12),
  check.names = FALSE
)

# Simular dados perdidos - MCAR
rct_mcar <- rct_data
rct_mcar[["Desfecho (pós)"]][sample(1:n, 30)] <- NA
rct_mcar$Idade[sample(1:n, 20)] <- NA

p1 <- naniar::gg_miss_upset(rct_mcar, nsets = 5)
p1
```

<br>

-   Dados perdidos ao acaso (*missing at random*, MAR), em que a probabilidade de ocorrência de dados perdidos é relacionada a outras variáveis medidas.[@Heymans2022; @carpenter2021]
<br>

```{r mar, echo = FALSE, warning = FALSE, message = FALSE, appendix = TRUE, fig.align = 'center', layout='Blank', ph=officer::ph_location_fullsize(), results = "asis", fig.fullwidth = TRUE, fig.cap = "Representação gráfica de dados perdidos ao acaso (MAR) em um estudo randomizado controlado (RCT)."}
# para reproduzir o exemplo
set.seed(123)

# Simulação de dados de um RCT
n <- 200
rct_data <- data.frame(
  id = 1:n,
  Grupo = sample(c("Controle", "Intervenção"), n, replace = TRUE),
  Idade = sample(40:75, n, replace = TRUE),
  Sexo = sample(c("M", "F"), n, replace = TRUE),
  "Desfecho (pré)" = rnorm(n, mean = 50, sd = 10),
  "Desfecho (pós)" = rnorm(n, mean = 55, sd = 12),
  check.names = FALSE
)

# Simular dados perdidos - MAR
rct_mar <- rct_data
rct_mar[["Desfecho (pós)"]][rct_mar$Grupo == "Intervenção" &
                              runif(n) < 0.3] <- NA
rct_mar$Idade[rct_mar$Sexo == "F" & runif(n) < 0.2] <- NA

# Visualização dos padrões de dados ausentes
graphics::par(mar = c(5, 4, 4, 2) + 0.1)

p2 <- naniar::gg_miss_upset(rct_mar, nsets = 5)
p2
```

<br>

-   Dados perdidos não ao acaso (*missing not at random*, MNAR), em que a probabilidade da ocorrência de dados perdidos é relacionada com a própria variável.[@Heymans2022; @carpenter2021]

<br>

```{r mnar, echo = FALSE, warning = FALSE, message = FALSE, appendix = TRUE, fig.align = 'center', layout='Blank', ph=officer::ph_location_fullsize(), results = "asis", fig.fullwidth = TRUE, fig.cap = "Representação gráfica de dados perdidos não ao acaso (MNAR) em um estudo randomizado controlado (RCT)."}
# para reproduzir o exemplo
set.seed(123)

# Simulação de dados de um RCT
n <- 200
rct_data <- data.frame(
  id = 1:n,
  Grupo = sample(c("Controle", "Intervenção"), n, replace = TRUE),
  Idade = sample(40:75, n, replace = TRUE),
  Sexo = sample(c("M", "F"), n, replace = TRUE),
  "Desfecho (pré)" = rnorm(n, mean = 50, sd = 10),
  "Desfecho (pós)" = rnorm(n, mean = 55, sd = 12),
  check.names = FALSE
)

# Simular dados perdidos - MNAR
rct_mnar <- rct_data
rct_mnar[["Desfecho (pós)"]][rct_mnar[["Desfecho (pós)"]] > 60 &
                               runif(n) < 0.5] <- NA
rct_mnar[["Desfecho (pré)"]][rct_mnar[["Desfecho (pré)"]] < 45 &
                               runif(n) < 0.4] <- NA

# Visualização dos padrões de dados ausentes
graphics::par(mar = c(5, 4, 4, 2) + 0.1)

p3 <- naniar::gg_miss_upset(rct_mnar, nsets = 5)
p3
```

<br>

### Como identificar o mecanismo gerador de dados perdidos em um banco de dados?

-   Por definição, não é possível avaliar se os dados foram perdidos ao acaso (MAR) ou não (MNAR).[@Heymans2022]

-   Testes t e regressões logísticas podem ser aplicados para identificar relações entre variáveis com e sem dados perdidos, criando um fator de análise ('dado perdido' = 1, 'dado observado' = 0).[@Heymans2022]

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *misty*[@misty] fornece a função [*na.test*](https://www.rdocumentation.org/packages/misty/versions/0.5.0/topics/na.test) para executar o Little's Missing Completely at Random (MCAR) test[@little1988].
:::

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *naniar*[@naniar] fornece a função [*mcar_test*](https://www.rdocumentation.org/packages/naniar/versions/1.0.0/topics/mcar_test) para executar o Little's Missing Completely at Random (MCAR) test[@little1988].
:::

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *naniar*[@naniar] fornece a função [*gg_miss_upset*](https://www.rdocumentation.org/packages/naniar/versions/1.0.0/topics/gg_miss_upset) para gerar o gráfico Upset para visualizar padrões de dados perdidos.
:::

<br>

## Estratégias para lidar com dados perdidos

<br>

### Que estratégias podem ser utilizadas na coleta de dados quando há expectativa de perda amostral?

-   Na expectativa de ocorrência de perda amostral, com consequente ocorrência de dados perdidos, recomenda-se ampliar o tamanho da amostra com um percentual correspondente a tal estimativa (ex.: 10%), embora ainda não corrija potenciais vieses pela perda.[@Altman2007]

<br>

### Que estratégias podem ser utilizadas na análise quando há dados perdidos?

-   Na ocorrência de dados perdidos, a análise mais comum compreende apenas os 'casos completos', com exclusão de participantes com algum dado perdido nas variáveis do estudo. Em casos de grande quantidade de dados perdidos, pode-se perder muito poder estatístico (erro tipo II elevado).[@Altman2007]

-   A análise de dados completos é válida quando pode-se argumentar que a probabilidade de o participante ter dados completos depende apenas das covariáveis e não dos desfechos.[@carpenter2021]

-   A análise de dados completos é eficiente quando todos os dados perdidos estão no desfecho, ou quando cada participante com dados perdidos nas covariáveis também possui dados perdidos nos desfechos.[@carpenter2021]

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *base*[@base] fornece a função [*na.omit*](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/na.fail) para remover dados perdidos de um objeto em um banco de dados.
:::

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
O pacote *stats*[@stats] fornece a função [*complete.cases*](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/complete.cases) para identificar os casos completos - isto é, sem dados perdidos - em um banco de dados.
:::

<br>

### Que estratégias podem ser utilizadas na redação de estudos em que há dados perdidos?

-   Informar: o número de participantes com dados perdidos; diferenças nas taxas de dados perdidos entre os braços do estudo; os motivos dos dados perdidos; o fluxo de participantes; quaisquer diferenças entre os participantes com e sem dados perdidos; o padrão de ausência (por exemplo, se é aleatória); os métodos para tratamento de dados perdidos das variáveis em análise; os resultados de quaisquer análises de sensibilidade; as implicações dos dados perdidos na interpretação do resultados.[@Akl2015]

<br>

## Dados imputados

<br>

### O que são dados imputados?

-   .[@REF]

<br>

### Quando a imputação de dados é indicada?

-   A análise com imputação de dados pode ser útil quando pode-se argumentar que os dados foram perdidos ao acaso (MAR); quando o desfecho foi observado e os dados perdidos estão nas covariáveis; e variáveis auxiliares --- preditoras do desfecho e não dos dados perdidos --- estão disponíveis.[@carpenter2021]

-   Na ocorrência de dados perdidos, a imputação de dados (substituição por dados simulados plausíveis preditos pelos dados presentes) pode ser uma alternativa para manter o erro tipo II estipulado no plano de análise.[@Altman2007]

<br>

### Quais são os métodos de imputação de dados?

-   Modelos lineares e logísticos podem ser utilizados para imputar dados perdidos em variáveis contínuas e dicotômicas, respectivamente.[@austin2023]

-   Os métodos de imputação de dados mais robustos incluem a imputação multivariada por equações encadeadas (*multivariate imputation by chained equations*, MICE)[@mice] e a correspondência média preditiva (*predictive mean matching*, PMM).[@rubin1986; @little1988a]

<br>

```{r impacto-imputacao, echo=FALSE, warning=FALSE, message=FALSE, appendix = TRUE, fig.align = 'center', layout='Blank', ph=officer::ph_location_fullsize(), results = "asis", fig.fullwidth = TRUE, fig.cap = "Impacto de métodos de imputação na distribuição de uma variável contínua com dados perdidos.", out.width = "100%"}
# para reproduzir o exemplo
set.seed(123)

# 1. Simular dados contínuos
n <- 300
x <- rnorm(n, mean = 50, sd = 10)

# 2. Introduzir dados perdidos (MCAR)
prop_na <- 0.20
na_idx <- sample(1:n, size = n * prop_na)
x_miss <- x
x_miss[na_idx] <- NA

# 3. Função da moda contínua (pico da densidade)
get_mode <- function(v) {
  d <- density(v, na.rm = TRUE)
  d$x[which.max(d$y)]
}

# Estatísticas com NA
media   <- mean(x_miss, na.rm = TRUE)
mediana <- median(x_miss, na.rm = TRUE)
moda    <- get_mode(x_miss)

# 4. Imputações simples
x_mean   <- ifelse(is.na(x_miss), media, x_miss)
x_median <- ifelse(is.na(x_miss), mediana, x_miss)
x_mode   <- ifelse(is.na(x_miss), moda, x_miss)

# 5. Imputação por PMM (Predictive Mean Matching)
library(mice)

# Variável auxiliar para permitir o modelo de imputação
df_mice <- data.frame(
  valor = x_miss,
  aux   = x + rnorm(n, 0, 5)  # variável auxiliar correlacionada (~0.8)
)

imp <- mice(df_mice, method = "pmm", m = 1, printFlag = FALSE)
x_pmm <- complete(imp)$valor

# 6. Médias e vieses
mean_original <- mean(x)

bias_mean   <- mean(x_mean)   - mean_original
bias_median <- mean(x_median) - mean_original
bias_mode   <- mean(x_mode)   - mean_original
bias_pmm    <- mean(x_pmm)    - mean_original

# 7. Data frame longo
df <- tibble::tibble(
  Método = c(rep("Original", n),
             rep("Imputação: Média", n),
             rep("Imputação: Mediana", n),
             rep("Imputação: Moda", n),
             rep("Imputação: PMM (MICE)", n)),
  Valor = c(x,
            x_mean,
            x_median,
            x_mode,
            x_pmm)
)

# 8. Criar rótulos com viés
label_fun <- function(meth) {
  if (meth == "Original") {
    paste0("Original\nMédia = ", round(mean_original, 2))
  } else if (meth == "Imputação: Média") {
    paste0("Imputação: Média\nMédia = ", round(mean(x_mean), 2),
           " | Viés = ", round(bias_mean, 2))
  } else if (meth == "Imputação: Mediana") {
    paste0("Imputação: Mediana\nMédia = ", round(mean(x_median), 2),
           " | Viés = ", round(bias_median, 2))
  } else if (meth == "Imputação: Moda") {
    paste0("Imputação: Moda\nMédia = ", round(mean(x_mode), 2),
           " | Viés = ", round(bias_mode, 2))
  } else {
    paste0("Imputação: PMM (MICE)\nMédia = ", round(mean(x_pmm), 2),
           " | Viés = ", round(bias_pmm, 2))
  }
}

df$Painel <- factor(df$Método,
                    levels = c("Original",
                               "Imputação: Média",
                               "Imputação: Mediana",
                               "Imputação: Moda",
                               "Imputação: PMM (MICE)"))

df$Painel_label <- sapply(as.character(df$Painel), label_fun)

# 9. Plot final com 5 painéis verticais
ggplot2::ggplot(df, ggplot2::aes(x = Valor)) +
  ggplot2::geom_histogram(ggplot2::aes(y = ggplot2::after_stat(density)),
                 bins = 30, fill = "skyblue", alpha = 0.5) +
  ggplot2::geom_density(color = "blue", size = 1) +
  ggplot2::geom_density(data = df |> dplyr::filter(Método == "Original"),
               ggplot2::aes(x = Valor),
               color = "red", size = 1, linetype = "dashed") +
  ggplot2::facet_wrap(~ Painel_label, ncol = 1, scales = "free_y") +
  ggplot2::theme_minimal(base_size = 14) +
  ggplot2::labs(
    x = "Valor",
    y = "Densidade"
  )
```

<br>

::: {.infobox .Rlogo data-latex="{images/Rlogo}"}
Os pacotes *mice*[@mice] e *miceadds*[@miceadds] fornecem funções [*mice*](https://www.rdocumentation.org/packages/mice/versions/3.16.0/topics/mice) e [*mi.anova*](https://www.rdocumentation.org/packages/miceadds/versions/3.16-18/topics/mi.anova) para imputação multivariada por equações encadeadas, respectivamente, para imputação de dados.
:::

<br>

```{r, echo=FALSE, warning=FALSE, results='asis', eval=knitr::is_html_output()}
cat(readLines("citation.html"), sep = "\n")
```

<br>
